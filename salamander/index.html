<!DOCTYPE html>
<html>
    <head>
        <title>Generated salamander</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            #generate{
                margin: auto;
                display: none;
            }
            #name{
                text-align: center;
                text-shadow: 2px 2px 0px #BBB;
            }
            #c{
                display: block;
                width: 314px;
                margin: 20px auto 0;
            }
        </style>
    </head>
    <body>
        <button id="generate">Re-Generate</button>
        <h1 id="name">Loading ... (<span id="percent">0</span>%)</h1>
        <canvas id="c" width="314" height="535"></canvas>
        <span id="poss"></span>
        <script src="../res/js/gameLib.js"></script>
        <script src="data.js"></script>
        <script>
            /* global Colors, Shapes */
            var poss = getById("poss");
            poss.innerHTML = (Colors.length * (Colors.length-1) * Shapes.length)+" possibilities";
            var images = Object.create(Shapes);
            images.push({
                name: "overlay",
                src: "overlay.png"
            });
            images.push({
                name: "primary",
                src: "primary.png"
            });
            var button = getById("generate"),
                title = getById("name"),
                percent = getById("percent"),
                can = getById("c"),
                ctx = can.getContext("2d"),
                media = loadMedia(images, function(p){
                    if(p >= 100){
                        button.style.display = "block";
                        button.onclick = generate;
                        generate();
                    }
                    else
                        percent.innerHTML = p.toFixed();
                });
            
            function generate(){
                var primColor = Colors[rand(Colors.length)],
                    shape = Shapes[rand(Shapes.length)],
                    secColor = Colors[rand(Colors.length)];
                
                while(secColor.name == primColor.name)
                    secColor = Colors[rand(Colors.length)];
                
                ctx.clear();
                
                // primary layer
                ctx.drawImage(ctx.compose(media.primary, primColor.code), 0, 0);
                
                // secondary layer
                ctx.drawImage(ctx.compose(media[shape.name], secColor.code), 0, 0);
                
                // eyes and shadow
                ctx.drawImage(media.overlay, 0, 0);
                
                title.innerHTML = secColor.name + " " + shape.name + " " + primColor.name;
            }
            
            function rand(max){
                return (Math.random()*max)<<0;
            }
            
            // Draw the image as an alpha layer of a color
            CanvasRenderingContext2D.prototype.compose = function(image, color){
                var canTmp = document.createElement("canvas");
                canTmp.width = image.width;
                canTmp.height = image.height;
                var ctxTmp = canTmp.getContext("2d");
                
                ctxTmp.drawImage(image, 0, 0);
                ctxTmp.globalCompositeOperation = "source-atop";
                ctxTmp.fillStyle = color;
                ctxTmp.fillRect(0, 0, canTmp.width, canTmp.height);
                
                return canTmp;
            };
        </script>
    </body>
</html>
