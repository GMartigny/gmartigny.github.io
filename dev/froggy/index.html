<!DOCTYPE html>
<html>
    <head>
        <title>Generated salamander</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            #generate{
                display: none;
            }
            #name{
                text-align: center;
            }
            #c{
                display: block;
                width: 314px;
                margin: 20px auto 0;
            }
        </style>
    </head>
    <body>
        <button id="generate">Re-Generate</button>
        <h1 id="name">Loading ...</h1>
        <canvas id="c" width="314" height="535"></canvas>
        <span id="poss"></span>
        <script src="../../res/js/gameLib.js"></script>
        <script src="data.js"></script>
        <script>
            /* global Colors, Shapes */
            var poss = getById("poss");
            poss.innerHTML = (Colors.length * (Colors.length-1) * Shapes.length)+" possibilities";
            var images = Object.create(Shapes);
            images.push({
                name: "base",
                src: "base.png"
            });
            images.push({
                name: "primary",
                src: "primary.png"
            });
            var button = getById("generate"),
                title = getById("name"),
                can = getById("c"),
                ctx = can.getContext("2d"),
                media = loadMedia(images, function(p){
                    if(p >= 100){
                        button.style.display = "block";
                        generate();
                    }
                });
            
            button.onclick = generate;
            
            function generate(){
                var primColor = Colors[rand(Colors.length)],
                    shape = Shapes[rand(Shapes.length)],
                    secColor = Colors[rand(Colors.length)];
                
                while(secColor.name == primColor.name)
                    secColor = Colors[rand(Colors.length)]
                
                ctx.clear();
                
                // primary layer
                ctx.drawImage(ctx.compose(media.primary, primColor.code), 0, 0);
                
                // secondary layer
                ctx.globalAlpha = 0.7;
                ctx.drawImage(ctx.compose(media[shape.name], secColor.code), 0, 0);
                
                // eyes and shadow
                ctx.drawImage(media.base, 0, 0);
                
                title.innerHTML = secColor.name + " " + shape.name + " " + primColor.name;
            }
            
            function rand(max){
                return (Math.random()*max)<<0;
            }
            
            CanvasRenderingContext2D.prototype.compose = function(image, color){
                var canSec = document.createElement("canvas");
                canSec.width = image.width;
                canSec.height = image.height;
                var ctxSec = canSec.getContext("2d");
                
                ctxSec.drawImage(image, 0, 0);
                ctxSec.globalCompositeOperation = "source-atop";
                ctxSec.fillStyle = color;
                ctxSec.fillRect(0, 0, canSec.width, canSec.height);
                
//                document.body.appendChild(canSec);
                
                return canSec;
            };
        </script>
    </body>
</html>
