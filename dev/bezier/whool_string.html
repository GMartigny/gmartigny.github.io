<!DOCTYPE html>
<html>
    <head>
        <title>Whool String</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            body{
                margin: 0;
            }
            #can{
                display: block;
                width: 800px;
                margin: 20px auto 0;
                background: #333;
            }
        </style>
    </head>
    <body>
        <div id="fps">0</div>
        <canvas width="800" height="600" id="can"></canvas>
        <script src="../fps.js"></script>
        <script src="spline.js"></script>
        <script>
            var can = document.getElementById("can"),
                ctx = can.getContext("2d"),
                theString,
                PI2 = Math.PI*2,
                cos = Math.cos,
                fps = new FPS(function(fr){
                    ctx.fillStyle = "#FFF";
                    ctx.fillText(fr, 5, 20);
                });
            
            function Whool(l, n){
                this.length = l;
                this.cells = [];
                
                this.inbetween = l/(n-1);
                
                var p = false;
                for(var i=0;i<n;++i){
                    p = new Cell(can.width/2, can.height/2, 0, 0, p);
                    this.cells.unshift(p);
                }
            }
            Whool.prototype.render = function(c){
                var allPos = [],
                    b;
                for(var i=0;i<this.cells.length;++i){
                    b = this.cells[i];
                    b.render(c);
                    if(b.distanceToNext() > this.inbetween) b.pullNext();
                    allPos.push(b.pos.x, b.pos.y);
                }
                
                c.beginPath();
                c.splineThrought(allPos, 0.3);
                c.stroke();
                c.closePath();
            };
            
            function Cell(x, y, vx, vy, n){
                this.pos = {
                    x: x,
                    y: y
                };
                this.vit = {
                    x: vx || 0,
                    y: vy || 0
                };
                this.acc = {
                    x: vx || 0,
                    y: vy || 0
                };
                this.lock = false;
                this.next = n || false;
            }
            Cell.prototype.render = function(c){
                c.beginPath();
                c.arc(this.pos.x, this.pos.y, 6, 0, PI2, 1);
                c.stroke();
                c.closePath();
                
                c.beginPath();
                c.moveTo(this.pos.x, this.pos.y);
                c.lineTo(this.pos.x+this.acc.x*200, this.pos.y+this.acc.y*200);
                c.stroke();
                c.closePath();
                

                if(!this.lock)this.move();
            };
            Cell.prototype.move = function(){
                
                this.vit.x += this.acc.x;
                this.vit.y += this.acc.y;
                
                this.pos.x += this.vit.x;
                this.pos.y += this.vit.y;
                
                this.acc.x = 0;
                this.acc.y = 0.1;
                
                this.vit.x /= 1.05;
                this.vit.y /= 1.05;
                
            };
            Cell.prototype.distanceToNext = function(){
                if(this.next)
                    return distance(this, this.next);
                else
                    return null;
            };
            Cell.prototype.pullNext = function(){
                if(this.next){
                    var n = this.next;
                    var d = distance(this, n);
                    n.vit.x += (this.pos.x-n.pos.x)/d;
                    n.vit.y += (this.pos.y-n.pos.y)/d;
                }
            };
            
            (function(){
                ctx.lineWidth = 2;
                
                theString = new Whool(200, 5);
                theString.cells[0].lock = true;
                
                draw();
            })();
            
            function draw(){
                window.requestAnimationFrame(draw);
                ctx.clearRect(0, 0, can.width, can.height);
                fps.update();
                
                ctx.strokeStyle = "#D11";
                
                theString.render(ctx);
            }
            
            function distance(p1, p2){
                return sqrt(sq(p2.pos.x - p1.pos.x) + sq(p2.pos.y - p1.pos.y));
            }
            
            window.onmousemove = function(e){
                theString.cells[0].pos.x = e.clientX-can.offsetLeft;
                theString.cells[0].pos.y = e.clientY-can.offsetTop;
            };
        </script>
    </body>
</html>
