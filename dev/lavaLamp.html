<!DOCTYPE html>
<html>
    <head>
        <title>Lava Lamp</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            body{
                margin: 0;
                background: #666;
            }
            #can{
                position: relative;
                display: block;
                width: 600px;
                margin: 50px auto 0;
                background: #333;
                box-shadow: 0 0 100px #111;
                cursor: none;
            }
        </style>
        <script src="../res/js/spline.js"></script>
    </head>
    <body>
        <canvas id="can" width="600" height="600"></canvas>
        <script>
            var can = document.getElementById("can"),
                ctx = can.getContext("2d"),
                bulle = {},
                PI2 = Math.PI*2,
                cos = Math.cos,
                sin = Math.sin,
                mouse = new Mouse(can);
            
            /* BULLE */
            function Bulle(x, y, r){
                this.pos = {
                    x: x,
                    y: y
                };
                this.surface = [];
                this.treshold = r;
                var n = r*PI2/80+1<<0,
                    re = n,
                    ra = 0;
                while(n--){
                    ra = n/re*PI2;
                    this.surface.push(new Cell(this, this.pos.x+r*cos(ra), this.pos.y+r*sin(ra), ra));
                }
            }
            Bulle.prototype.render = function(){
                var l = this.surface.length,
                    dots = [];
                while(l--)
                    dots.push(this.surface[l].pos.x, this.surface[l].pos.y);
                
                ctx.lineWidth = 5;
                ctx.beginPath();
                ctx.splineThrought(dots, 0.4, true);
                ctx.stroke();
                ctx.closePath();
                
                this.surface.forEach(function(e){
                    e.render();
                });
            };
            
            /* CELLULE */
            function Cell(p, x, y, v){
                this.pos = {
                    x: x,
                    y: y
                };
                this.parent = p;
                
                this.vector = v;
                this.speed = 0;
            }
            Cell.prototype.render = function(){
                ctx.beginPath();
                ctx.arc(this.pos.x, this.pos.y, 5, 0, PI2, true);
                ctx.fill();
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(this.pos.x, this.pos.y);
                ctx.lineTo(this.pos.x+this.speed*cos(this.vector)*50,
                    this.pos.y+this.speed*sin(this.vector)*50);
                ctx.stroke();
                this.move();
            };
            Cell.prototype.move = function(){
                this.pos.x += this.speed*cos(this.vector);
                this.pos.y += this.speed*sin(this.vector);
                
                this.speed /= 1.05;
            };
            
            /* MOUSE */
            function Mouse(el){
                this.pos = false;
                
                this.speed = 0;
                
                var self = this;
                window.onmousemove = function(e){
                    var p = {
                        x: e.clientX - el.offsetLeft,
                        y: e.clientY - el.offsetTop
                    };
                    
                    if(self.pos) self.speed = distance(self.pos, p);
                    self.pos = p;
                    
                    bulle.surface.forEach(function(cell){
                        cell.speed = self.speed;
                    });
                };
            }
            Mouse.prototype.render = function(){
                ctx.beginPath();
                ctx.arc(this.x, this.y, 5, 0, PI2, true);
                ctx.fill();
            };
            
            (function (){
                bulle = new Bulle(can.width/2, can.height/2, 200);
                
                ctx.strokeStyle = "#FFF";
                ctx.fillStyle = "#FFF";
                
                loop();
            })();
            function loop(){
                window.requestAnimationFrame(loop);
                
                ctx.clearRect(0, 0, can.width, can.height);
                bulle.render();
                mouse.render();
            }
            
            function random(from, to){
                return (from + Math.random()*(to-from))+0.5<<0;
            }
            function distance(from, to){
                return sqrt(sq(from.x-to.x)+sq(from.y-to.y));
            }
        </script>
    </body>
</html>
