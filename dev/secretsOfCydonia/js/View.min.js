
function ViewManager(a,b,c){this.ready=false;this.ground=new GroundView(a.ground.ctx,c);this.block=new BlockView(a.block.ctx,c);this.layers=[this.ground,new UnderView(a.under.ctx,c),this.block,new OverView(a.over.ctx,c)];this.overlay=a.overlay;getImageDataFromUrl("res/match.png",function(d){View.match=d},this);View.tileSet=b}ViewManager.prototype={checkReady:function(){var a=true;this.layers.forEach(function(b){a&=b.ready});return this.ready=a},renderAll:function(a,b){if(this.ready){this.layers.forEach(function(c){c.render(a,b)})}},isBlocked:function(j,h,b){var d=[],f=0.1,e=0.7,m=0.1,a=Player.SPEED;switch(b){case Player.DIR_UP:d=[{x:(j+f+a),y:(h+e)},{x:(j-f-a+1),y:(h+e)}];break;case Player.DIR_DOWN:d=[{x:(j+f+a),y:(h-m+1)},{x:(j-f-a+1),y:(h-m+1)}];break;case Player.DIR_LEFT:d=[{x:(j+f),y:(h+e+a)},{x:(j+f),y:(h-m-a+1)}];break;case Player.DIR_RIGHT:d=[{x:(j-f+1),y:(h+e+a)},{x:(j-f+1),y:(h-m-a+1)}];break}var k={};for(var g=0,c=d.length;g<c;++g){k=this.ground.data.get(floor(d[g].x),floor(d[g].y));if(!k||!k.isOpac()){return{x:d[g].x,y:d[g].y}}if(this.block.data.get(floor(d[g].x),floor(d[g].y)).isOpac()){return{x:d[g].x,y:d[g].y}}}return false},setMap:function(a){this.layers.forEach(function(b){b.getData(a)})}};function View(a,c,b){this.layer=a;this.data;this.rendering={};this.defaultHexa=b||false;this.layer.fillStyle=b;this.randomize=false;this.ready=false;this.getData(c)}View.match;View.tileSet;View.prototype={getData:function(a){this.ready=false;getImageDataFromUrl("res/"+a+"/"+this.name+".png",this.catchData,this)},catchData:function(a){this.data=a;var k=document.createElement("canvas"),j=k.getContext("2d"),i=GameController.cell;k.width=a.width*i;k.height=a.height*i;var b={},h="",d={};for(var e=0,g=a.width;e<g;++e){for(var c=0,f=a.height;c<f;++c){b=a.get(e,c);if(b&&b.isOpac()){h=b.getHexa()}else{h=0}if(h&&(d=this.getTilePos(h))){j.save();j.translate(floor((e+0.5)*i),floor((c+0.5)*i));if(this.randomize){j.rotate(floor(random(0,3))*PI/2)}j.drawImage(View.tileSet,d.x*i,d.y*i,i,i,-floor(i/2),-floor(i/2),i,i);j.restore()}}}this.rendering=k;this.ready=true},render:function(c,e){this.layer.clear();var b=GameController.cell,d=GameController.nbCol*b,a=GameController.nbRow*b;if(this.defaultHexa){this.layer.fillRect(0,0,d,a)}this.layer.drawImage(this.rendering,(c)*b,(e)*b,d,a,0,0,d,a);this.anim+=this.spd},getTilePos:function(d){for(var a=0,b=View.match.width;a<b;++a){for(var e=0,c=View.match.height;e<c;++e){if(View.match.get(a,e).getHexa()===d){return{x:a,y:e}}}}return false}};function GroundView(a,b){View.call(this,a,b,"#97d4f7");this.randomize=true}GroundView.prototype=Object.create(View.prototype);GroundView.prototype.name="grd";function UnderView(a,b){View.call(this,a,b)}UnderView.prototype=Object.create(View.prototype);UnderView.prototype.name="und";function BlockView(a,b){View.call(this,a,b)}BlockView.prototype=Object.create(View.prototype);BlockView.prototype.name="blk";function OverView(a,b){View.call(this,a,b)}OverView.prototype=Object.create(View.prototype);OverView.prototype.name="ovr";