
function ViewManager(b,c,d){this.ready=false;this.ground=new GroundView(b.ground.ctx);this.block=new View(b.block.ctx,View.BLOCK_NAME);this.under=new View(b.under.ctx,View.UNDER_NAME);this.over=new View(b.over.ctx,View.OVER_NAME);this.layers=[this.ground,this.under,this.block,this.over];this.overlay=b.overlay;var a=new Image("res/match.png");a.onload=function(){View.match=this.getData()};View.tileSet=c;this.setMap(d)}ViewManager.prototype={checkReady:function(){var a=true;this.layers.forEach(function(b){a&=b.ready});return this.ready=a},renderAll:function(a){if(this.ready){this.layers.forEach(function(b){b.render(a)})}},isBlocked:function(j,h,b){var d=[],f=0.1,e=0.7,k=0,a=Player.SPEED;switch(b){case Player.DIR_UP:d=[{x:floor(j+f+a),y:floor(h+e)},{x:floor(j-f-a+1),y:floor(h+e)}];break;case Player.DIR_DOWN:d=[{x:floor(j+f+a),y:floor(h-k+1)},{x:floor(j-f-a+1),y:floor(h-k+1)}];break;case Player.DIR_LEFT:d=[{x:floor(j+f),y:floor(h+e+a)},{x:floor(j+f),y:floor(h-k-a+1)}];break;case Player.DIR_RIGHT:d=[{x:floor(j-f+1),y:floor(h+e+a)},{x:floor(j-f+1),y:floor(h-k-a+1)}];break}for(var g=0,c=d.length;g<c;++g){if(!this.ground.tileAt(d[g].x,d[g].y)||this.block.tileAt(d[g].x,d[g].y)){return{x:d[g].x,y:d[g].y}}}return false},setMap:function(a){this.layers.forEach(function(b){b.getData(a)})}};function View(a,b){this.layer=a;this.data;this.name=b;this.rendering;this.ready=false}View.GROUND_NAME="grd";View.UNDER_NAME="und";View.BLOCK_NAME="blk";View.OVER_NAME="ovr";View.match;View.tileSet;View.prototype={getData:function(b){this.ready=false;var b=new Image("res/"+b+"/"+this.name+".png");var a=this;b.onload=function(){a.catchData.call(a,b.getData())}},catchData:function(b){this.data=b;var j=document.createElement("canvas"),i=j.getContext("2d");this.rendering=i;j.width=b.width*GameController.cell;j.height=b.height*GameController.cell;var c={},g="",a={};for(var e=0,h=b.width;e<h;++e){for(var d=0,f=b.height;d<f;++d){c=b.get(e,d);if(c&&c.isOpac()){g=c.getHexa()}else{g=0}if(g&&(a=this.getTilePos(g))){this.drawTile(e,d,a)}}}this.ready=true},drawTile:function(b,d,c){var a=GameController.cell;this.rendering.drawImage(View.tileSet,c.x*a<<0,c.y*a<<0,a,a,b*a,d*a,a,a)},tileAt:function(a,c){var b=this.data.get(a,c);if(b){return b.isOpac()}return false},clear:function(){this.layer.clear()},render:function(d){this.clear();var b=GameController.cell,c=GameController.nbCol*b,a=GameController.nbRow*b;this.layer.drawImage(this.rendering.canvas,d.x*b,d.y*b,c,a,0,0,c,a);this.anim+=this.spd},getTilePos:function(d){for(var a=0,b=View.match.width;a<b;++a){for(var e=0,c=View.match.height;e<c;++e){if(View.match.get(a,e).getHexa()===d){return{x:a,y:e}}}}return false}};function GroundView(a){View.call(this,a,"grd");this.layer.fillStyle="#97d4f7"}GroundView.prototype=Object.create(View.prototype);GroundView.prototype.clear=function(){this.layer.fillRect(0,0,this.layer.canvas.width,this.layer.canvas.height)};GroundView.prototype.drawTile=function(b,e,d){var c=this.rendering,a=GameController.cell;c.save();c.translate((b+0.5)*a<<0,(e+0.5)*a<<0);c.rotate((random(0,3)<<0)*PI/2);c.drawImage(View.tileSet,d.x*a<<0,d.y*a<<0,a,a,-0.5*a<<0,-0.5*a<<0,a,a);c.restore()};