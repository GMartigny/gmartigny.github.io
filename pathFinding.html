<!DOCTYPE html>
<html>
    <head>
        <title>A* Path Finder</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            html, body{
                margin: 0;
                padding: 0;
                height: 100%;
                background: #111;
            }
            #can{
                display: block;
                width: 100%;
                height: 100%;
                cursor: crosshair;
            }
        </style>
    </head>
    <body>
        <canvas id="can"></canvas>
        <script>
            var opened = [],
                grid,
                ctx,
                running = false,
                pointer = false,
                mouse = {
                    x: -100,
                    y: -100,
                    down: false,
                    hover: false
                };
            
            window.onmousemove = function(e){
                if(!running){
                    mouse.x = e.clientX/Tile.size<<0;
                    mouse.y = e.clientY/Tile.size<<0;

                    if(mouse.hover){
                        mouse.hover.state <<= 0;
                        mouse.hover.render();
                    }
                    mouse.hover = grid.get(mouse.x, mouse.y);
                    if(mouse.hover){
                        mouse.hover.state += 0.5;
                        if(mouse.down)
                            mouse.hover.state = mouse.down;
                        mouse.hover.render();
                    }
                }
            };
            window.onmouseout = function(){
                if(mouse.hover){
                    mouse.hover.state <<= 0;
                    mouse.hover.render();
                }
                mouse.hover = false;
            };
            window.onmousedown = function(){
                mouse.down = 2;
                if(mouse.hover){
                    if(mouse.hover.state >= 2)
                        mouse.down = 1;
                    mouse.hover.state = mouse.down;
                }
            };
            window.onmouseup = function(){
                mouse.down = false;
            };
            window.onkeydown = function(e){
                console.log(e.keyCode);
                if(e.keyCode == 13){ // enter
                    if(mouse.hover){
                        mouse.hover.state <<= 0;
                        mouse.hover.render();
                    }
                    running = true;
                    evaluate(grid.start);
                    findPath();
                }
                else if(e.keyCode == 32){ // space
                    grid.forEach(function(t){
                        if(t !== grid.start && t !== grid.finish){
                            t.state = (Math.random()+1.25)<<0;
                            t.render();
                        }
                    });
                }
                else if(e.keyCode == 27){ // escape
                    clearTimeout(running);
                    running = false;
                    grid = new Grid(ctx.canvas.width, ctx.canvas.height);
                    grid.render();
                }
            };
            
            // PATHFINDER
            function PathFinder(){
                this.opened = [];
                this.running = false;
                this.pointer = false;
            }
            PathFinder.prototype.find = function(){
                
            };
            PathFinder.prototype.evaluate = function(){
                
            };
            PathFinder.prototype.path = function(){
                
            };
            
            // GRID
            function Grid(w, h){
                this.tiles = [];
                opened = [];
                running = false;
                pointer = false;
                
                var rows = h/Tile.size<<0,
                    cols = w/Tile.size<<0;
                for(var i=0;i<rows;++i){
                    if(!this.tiles[i])
                        this.tiles[i] = [];
                    for(var j=0;j<cols;++j){
                        this.tiles[i].push(new Tile(j, i));
                    }
                }
                
                this.start = this.tiles[0][0];
                this.start.state = 3;
                this.finish = this.tiles[rows-1][cols-1];
                this.finish.state = 4;
            }
            Grid.prototype.get = function(x, y){
                if(this.tiles[y])
                    return this.tiles[y][x] || false;
                else return false;
            };
            Grid.prototype.forEach = function(f){
                var rows = this.tiles.length,
                    cols = this.tiles[0].length;
                for(var i=0;i<rows;++i){
                    for(var j=0;j<cols;++j){
                        f(this.tiles[i][j]);
                    }
                }
            };
            Grid.prototype.render = function(){
                this.forEach(function(t){
                    t.render();
                });
            };
            
            // TILE
            function Tile(x, y){
                this.pos = {
                    x: x,
                    y: y
                };
                this.state = 1;
                this.weight = 0;
                this.comeFrom = false;
            }
            Tile.size = 20;
            Tile.prototype.render = function(){
                switch(this.state){
                    case 1: // Inactive
                        ctx.fillStyle = "#FFF";
                        break;
                    case 1.5: // Hovered
                        ctx.fillStyle = "#DDD";
                        break;
                    case 2: // Block
                        ctx.fillStyle = "#111";
                        break;
                    case 2.5: // Hovered
                        ctx.fillStyle = "#333";
                        break;
                    case 3: // Start
                    case 4: // Finish
                        ctx.fillStyle = "#A33";
                        break;
                    case 10: // Opened
                        ctx.fillStyle = "#0EF";
                        break;
                    case 20: // Evaluated
                        ctx.fillStyle = "#25F";
                        break;
                    case 30: // Path
                        ctx.fillStyle = "#2F2";
                }
                
                var s = Tile.size;
                ctx.beginPath();
                ctx.rect(this.pos.x*s, this.pos.y*s, Tile.size-1, Tile.size-1);
                ctx.stroke();
                ctx.fill();
                
                if(this.comeFrom){
                    ctx.beginPath();
                    ctx.moveTo(this.pos.x*s+s/2, this.pos.y*s+s/2);
                    ctx.lineTo(this.comeFrom.pos.x*s+s/2, this.comeFrom.pos.y*s+s/2);
                    ctx.stroke();
                    ctx.closePath();
                }
            };
            Tile.prototype.around = function(){
                var res = [];
                var t = grid.get(this.pos.x-1, this.pos.y);
                if(t) res.push(t);
                var t = grid.get(this.pos.x+1, this.pos.y);
                if(t) res.push(t);
                var t = grid.get(this.pos.x, this.pos.y-1);
                if(t) res.push(t);
                var t = grid.get(this.pos.x, this.pos.y+1);
                if(t) res.push(t);
                return res;
            };
            Tile.prototype.distance = function(t){
                return Math.sqrt(Math.pow(this.pos.x - t.pos.x, 2) + Math.pow(this.pos.y - t.pos.y, 2));
            };
            
            (function(){
                var can = document.getElementById("can");
                can.width = document.body.offsetWidth;
                can.height = document.body.offsetHeight;
                
                ctx = can.getContext("2d");
                ctx.strokeStyle = "#333";
                ctx.lineWidth = 1;
                
                grid = new Grid(can.width, can.height);
                
                grid.render();
            })();
            
            function findPath(){
                if(opened.length){
                    var closest = opened[0],
                        minDist = closest.distance(grid.finish)+closest.weight,
                        l = opened.length;
                    for(var i=1;i<l;++i){
                        var d = opened[i].distance(grid.finish)+opened[i].weight;
                        if(d < minDist){
                            closest = opened[i];
                            minDist = d;
                        }
                    }
                    
                    closest.state = 20;
                    opened.splice(opened.indexOf(closest), 1);
                    closest.render();
                    
                    if(evaluate(closest))
                        running = setTimeout(findPath, 100);
                }
                else{
                    alert("No possible Path");
                }
            }
            function evaluate(current){
                var arr = current.around(),
                    again = true;
                arr.forEach(function(t){
                    if(t.state != 2 && t.state != 3 && t.state != 10 && t.state != 20){
                        if(t === grid.finish){
                            pointer = current;
                            reconstructPath();
                            again = false;
                        }
                        else{
                            t.comeFrom = current;
                            t.weight = current.weight+0.5;
                            t.state = 10;
                            t.render();
                            opened.push(t);
                        }
                    }
                });
                return again;
            }
            function reconstructPath(){
                if(pointer.comeFrom){
                    pointer.state = 30;
                    pointer.render();
                    pointer = pointer.comeFrom;
                    running = setTimeout(reconstructPath, 50);
                }
            }
        </script>
    </body>
</html>
